<!DOCTYPE html>
<html  style="height: 100%;" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title></title>  
    
    <script src="/SiteEngine/Client/js/lib/require.js"></script>    
    <script src="/SiteEngine/Client/js/lib/angular/angular.js"></script>

    <link rel="stylesheet" type="text/css" href="/SiteEngine/Client/layouts/LayoutWrapper.css">
    <link rel="stylesheet" type="text/css" href="/SiteEngine/Client/js/components/ComponentMgr.css">

  </head>
    
<body style="margin: 0;height: 100%;">

  <div id="loadingApp" class="dvLoading">
      <div class="dvLoadingContent" >
        <div class="dvElem">
          <img src="/SiteEngine/Client/images/loading.gif">
        </div>
      </div>
  </div>

  <div ng-app="app" ng-controller="ctrlApp" style="height: 100%;">
    <div class="dvEditPanel">
      <table>
        <tr>
          <td class="tdInfo"><span>Edit mode</span></td>
          <td>
            <div class="dvActions">
              <a href="" id="btn_save" action="saveItem" class="button-ribbon" onclick="" >Save</a>
            </div>
          </td>
        </tr>
      </table>
    </div>
    <div id="wrapperContent" style="display: block; margin: 0 auto;height: 100%;" >

      <!--<div id="loadingElem" style="display: table-cell;vertical-align: middle;">      
        <img src="/SiteEngine/Client/images/loading.gif" style="width: 48px;height: 48px;">
      </div>-->

    </div>
  </div>
  
<!--    <script src="/SiteEngine/Client/js/lib/require.js"></script>    
    <script src="/SiteEngine/Client/js/lib/angular/angular.js"></script>-->

<script>

  var _$scope;
  var _$compile;
  var _$http;
  var _$parse;
  var app = angular.module("app", []);


  app.controller("ctrlApp", ["$scope", "$compile", "$http", "$rootScope", "$parse", function ($scope, $compile, $http, $rootScope, $parse) {
    _$scope = $scope;
    _$compile = $compile;
    _$http = $http;
    _$parse = $parse;

    _$scope.wrapperReady = function () {

    };    

  }]);

  function parseBindingElem(elem) {
    if (!elem)
      return;

    try {
      var className = elem.className;
      if (className &&
          (className.indexOf("ng-binding") >= 0 || className.indexOf("ng-pristine") >= 0)) {
        var $el = $(elem);
        var bindingValue;
        if ($el.val().indexOf("{{") >= 0 && $el.val().indexOf("}}") >= 0) {
          bindingValue = $el.val();
        } else if ($el.html().indexOf("{{") >= 0 && $el.html().indexOf("}}") >= 0) {
          bindingValue = $el.html();
        } else if ($el.attr("ng-bind")) {
          bindingValue = $el.attr("ng-bind");
        } else if ($el.attr("ng-model")) {
          bindingValue = $el.attr("ng-model");
        }

        if (bindingValue) {
          var val = bindingValue;
          val = val.replace("{{", "").replace("}}", "");
          val = val.trim('');
          if (val) {
            var arPart = val.split('.');
            if (arPart.length > 0)
              $el.attr("bindObj", arPart[0]);
            if (arPart.length > 1)
              $el.attr("bindField", arPart[1]);
            if (arPart.length > 2)
              $el.attr("bindSubField", arPart[2]);
          }
        }
      }
      if (elem.childNodes) {
        for (var i = 0; i < elem.childNodes.length; i++) {
          parseBindingElem(elem.childNodes[i]);
        }
      }
    }
    catch (ex) { }

  };


  app.directive('editing', function () {
    return function (scope, element, attrs) {
      if (element && element.length > 0)
        parseBindingElem(element[0]);
    }
  });

  require.config({
    paths: {
      jquery: "/SiteEngine/Client/js/lib/jquery-1.11.3",
      jqueryUi: "/SiteEngine/Client/js/lib/jquery-ui/jquery-ui",
      underscore: "/SiteEngine/Client/js/lib/underscore",
      bootstrap: "/SiteEngine/Client/js/lib/bootstrap/bootstrap",
      angular: "/SiteEngine/Client/js/lib/angular/angular",
      angularRoute: "/SiteEngine/Client/js/lib/angular-route/angular-route",

      AppConfig: "/SiteEngine/Common/appConfig",
      //CONST: "/SiteEngine/Client/js/const",
      CONST: "/SiteEngine/Common/Const",
      application: "/SiteEngine/Client/js/application",
      notification: "/SiteEngine/Client/Views/forms/notificationForm/notification",
      CommonTypes: "/SiteEngine/Client/js/Common/CommonTypes",
      Utils: "/SiteEngine/Client/js/Common/Utils",

      SiteInitialization: "/SiteEngine/Site/js/siteInitialization",
    },

    "shim": {
        angular: { "exports": "angular" },
        angularRoute: ["angular"],

        bootstrap: ["jquery"],
        jquery: {
          exports: "jQuery"
        },
        jqueryUi: ["jquery"],
        application: ["jquery"],
        notification: ["jquery"],
      },
    map: {
      "*": {
        "css": "/SiteEngine/Client/js/lib/require-css/css.js",
      }
    },
    
  });

  require(["jquery", "underscore", "application", "CONST", "Utils", "SiteInitialization", "bootstrap", "css!bootstrap"], function ($, _, application, CONST, Utils, SiteInitialization) {

    //var path = "main/test2";
    //var path = "main";
    //var serverAddress = "http://localhost:8082/" + path;

    //Utils.setLoadingApplication(true);

    var serverAddress = CONST.SERVER.PATH() + (window.location.pathname + window.location.search);

    application.initialize(_$scope, _$http);
    application.loadItems(function () {
      var itemsHash = application.getItemsHash();
      SiteInitialization.bindItems(_$scope, itemsHash);
    });

    $(".button-ribbon").click(function (event) {
      var $curTarget = $(event.currentTarget);
      var action = $curTarget.attr("action");
      //if (action && action != "")
        //$(self).trigger(EVENT_CLICK_BUTTON, action);
    });

    function loadIncludeFile(includePath, callback) {
      $.get(includePath).success(function (data, status, headers) {
        if (callback)
          callback(includePath, data);
      });

    };

    function renderSite(contentSource){
      var intervalWait = setInterval(function(){
        if(SiteInitialization.isItemsBound()) {
          clearInterval(intervalWait);

          try {

            //var $contentSource = $("<html></html").html(contentSource)
            //var $arInclude = $contentSource.find("[ng-include]");
            //var hashFile = {};
            //var indexLoad = 0;
            //var countLoad = $arInclude.length;
            //_.each($arInclude, function (include) {
            //  var includePath = $(include).attr("ng-include");
            //  includePath = includePath.replace("'", "").replace("'", "");
            //  hashFile[includePath] = include;
            //  $(include).removeAttr("ng-include");

            //  loadIncludeFile(includePath, function (path, data) { 
            //    if (hashFile[path]) {
            //      $(hashFile[path]).html(data);
            //      indexLoad++;
            //    }
            //    if (indexLoad == countLoad) {
            //      //var contentFn = _$compile(contentSource);
            //      var contentFn = _$compile($contentSource.html());
            //      var contentElems = contentFn(_$scope);

            //      $("#wrapperContent").html(contentElems);
            //      _$scope.$apply();
            //    }              
            //  });
            //});

            //return;

            var contentFn = _$compile(contentSource);
            //var contentFn = _$compile($contentSource.html());
            var contentElems = contentFn(_$scope);


            $("#wrapperContent").html(contentElems);

            //return;
            _$scope.$apply();

            var isIncludeContentLoaded = false;
            var lastDateTimeIncludeContent = Date.now();
            //$rootScope.$on('$includeContentLoaded', function(event) {
            _$scope.$on('$includeContentLoaded', function (event, a, b, c) {
              //$('#output').append('<p>' + event.targetScope.name + ' include\'s content was loaded.</p>');
              isIncludeContentLoaded = true;
              lastDateTimeIncludeContent = Date.now();
            });

            //var maxIncludeWait = 1000;
            //var intervalIncludeWait = setInterval(function () {
            //  var dtNow = Date.now();
            //  console.log("diff=" + (dtNow - lastDateTimeIncludeContent));
            //  if ((dtNow - lastDateTimeIncludeContent) > maxIncludeWait) {
            //    clearInterval(intervalIncludeWait);
            //    parseBindingElems(contentElems);

            //    //_$scope.$apply();
            //  }
            //}, 100);

            //setInterval(function(){
            //  if(isIncludeContentLoaded){
            //    isIncludeContentLoaded = false;
            //    var arBindingElems = $(".ng-binding");
            //    _.each(arBindingElems, function(elem){
            //      var nodeName = elem.nodeName.toLowerCase();
            //      if(nodeName == "span"){
            //        var parent = $(elem).parent();
            //        if(parent.length > 0 && 
            //          (parent[0].nodeName.toLowerCase() == "div" || parent[0].nodeName.toLowerCase() == "a")){
            //          parent.addClass("ngBindingHover");
            //        } else
            //          $(elem).addClass("ngBindingHover");                    
            //      } else {
            //        $(elem).addClass("ngBindingHover");
            //      }
            //    });

            //  }
            //}, 400);

          } catch(ex) {
          }
        }
      }, 10);
    };

    // get content of the site
    var data = { action: "getContentSite" };
    $.post(serverAddress, data, function (responseData, textStatus, jqXHR) {
      if (jqXHR && jqXHR.status === 200) {
        responseData = JSON.parse(responseData);
        if (!responseData.error) {
          if (responseData.data && responseData.data.layoutItem) {
            var layoutItem = responseData.data.layoutItem;
            if (layoutItem.layoutContent) {

              var contentSource = layoutItem.layoutContent;              
              
              //
              renderSite(contentSource);
            }
          }
        } else {
          $("#wrapperContent").html(responseData.error);
        }

      } else {

      }

    });

  });

</script>

  </body>
</html>


